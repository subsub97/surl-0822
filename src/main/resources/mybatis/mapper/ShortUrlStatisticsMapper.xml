<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.megastudy.surlkdh.domain.statistics.infrastructure.mybatis.mapper.ShortUrlStatisticsMapper">


    <resultMap id="statisticsResultMap"
               type="com.megastudy.surlkdh.domain.statistics.controller.dto.response.StatisticsDataPoint">
        <result property="key" column="key_column"/>
        <result property="clicks" column="clicks_column"/>
    </resultMap>

    <resultMap id="shortUrlClickResultMap"
               type="com.megastudy.surlkdh.domain.statistics.entity.ShortUrlClicks">
        <result property="shortUrlId" column="short_url_id"/>
        <result property="countryCode" column="country_code"/>
        <result property="deviceType" column="device_type"/>
        <result property="referrer" column="referrer"/>
        <result property="domain" column="domain"/>
        <result property="createdAt" column="created_at"/>
    </resultMap>

    <!-- 공통 WHERE 조건문 -->
    <sql id="commonFilterClause">
        <if test="request.startDate != null">
            AND created_at &gt;= #{request.startDate}
        </if>
        <if test="request.endDate != null">
            AND created_at &lt;= #{request.endDate}
        </if>
    </sql>

    <!-- 동적 그룹 통계 조회 쿼리 -->
    <select id="findStatisticsByShortUrl" resultMap="statisticsResultMap">
        SELECT
        <choose>
            <when test="request.groupBy.name() == 'DEVICE'">device_type</when>
            <when test="request.groupBy.name() == 'COUNTRY'">country_code</when>
            <when test="request.groupBy.name() == 'REFERRER'">referrer</when>
            <when test="request.groupBy.name() == 'DAILY'">FORMAT(created_at, 'yyyy-MM-dd')</when>
            <when test="request.groupBy.name() == 'MONTHLY'">FORMAT(created_at, 'yyyy-MM')</when>
            <when test="request.groupBy.name() == 'HOURLY'">FORMAT(created_at, 'yyyy-MM-dd HH:00')</when>
            <when test="request.groupBy.name() == 'MINUTELY'">FORMAT(created_at, 'yyyy-MM-dd HH:mm')</when>
            <when test="request.groupBy.name() == 'SECONDLY'">FORMAT(created_at, 'yyyy-MM-dd HH:mm:ss')</when>
            <otherwise>device_type</otherwise>
        </choose>
        AS key_column,
        COUNT(*) AS clicks_column
        FROM
        short_url_clicks
        <where>
            short_url_id = #{shortUrlId}
            <include refid="commonFilterClause"/>
        </where>
        GROUP BY
        <choose>
            <when test="request.groupBy.name() == 'DEVICE'">device_type</when>
            <when test="request.groupBy.name() == 'COUNTRY'">country_code</when>
            <when test="request.groupBy.name() == 'REFERRER'">referrer</when>
            <when test="request.groupBy.name() == 'DAILY'">FORMAT(created_at, 'yyyy-MM-dd')</when>
            <when test="request.groupBy.name() == 'MONTHLY'">FORMAT(created_at, 'yyyy-MM')</when>
            <when test="request.groupBy.name() == 'HOURLY'">FORMAT(created_at, 'yyyy-MM-dd HH:00')</when>
            <when test="request.groupBy.name() == 'MINUTELY'">FORMAT(created_at, 'yyyy-MM-dd HH:mm')</when>
            <when test="request.groupBy.name() == 'SECONDLY'">FORMAT(created_at, 'yyyy-MM-dd HH:mm:ss')</when>
            <otherwise>device_type</otherwise>
        </choose>
        <!-- 동적 정렬 -->
        <if test="pageable.sort.isSorted()">
            ORDER BY
            <foreach collection="pageable.sort" item="order" separator=",">
                <choose>
                    <when test="order.property == 'clicks'">clicks_column ${order.direction}</when>
                    <when test="order.property == 'key'">key_column ${order.direction}</when>
                    <otherwise>clicks_column DESC</otherwise>
                </choose>
            </foreach>
        </if>
        <if test="!pageable.sort.isSorted()">
            ORDER BY clicks_column DESC
        </if>
        OFFSET #{pageable.offset} ROWS
        FETCH NEXT #{pageable.pageSize} ROWS ONLY
    </select>


    <select id="countStatisticsByShortUrl" resultType="long">
        SELECT
        COUNT(DISTINCT
        <choose>
            <when test="request.groupBy.name() == 'DEVICE'">device_type</when>
            <when test="request.groupBy.name() == 'COUNTRY'">country_code</when>
            <when test="request.groupBy.name() == 'REFERRER'">referrer</when>
            <when test="request.groupBy.name() == 'DAILY'">FORMAT(created_at, 'yyyy-MM-dd')</when>
            <when test="request.groupBy.name() == 'MONTHLY'">FORMAT(created_at, 'yyyy-MM')</when>
            <when test="request.groupBy.name() == 'HOURLY'">FORMAT(created_at, 'yyyy-MM-dd HH:00')</when>
            <when test="request.groupBy.name() == 'MINUTELY'">FORMAT(created_at, 'yyyy-MM-dd HH:mm')</when>
            <when test="request.groupBy.name() == 'SECONDLY'">FORMAT(created_at, 'yyyy-MM-dd HH:mm:ss')</when>
            <otherwise>device_type</otherwise>
        </choose>
        )
        FROM
        short_url_clicks
        <where>
            short_url_id = #{shortUrlId}
            <include refid="commonFilterClause"/>
        </where>
    </select>

    <select id="countShortUrlClicksById" resultType="long">
        SELECT
        COUNT (*)
        FROM
        short_url_clicks
        WHERE
        short_url_id = #{shortUrlId}
        <include refid="commonFilterClause"/>
    </select>

    <select id="findShortUrlClicksById" resultMap="shortUrlClickResultMap">
        SELECT
        short_url_id,
        country_code,
        device_type,
        referrer,
        domain,
        created_at
        FROM
        short_url_clicks
        WHERE
        short_url_id = #{shortUrlId}
        <include refid="commonFilterClause"/>
        <if test="pageable.sort.isSorted()">
            ORDER BY
            <foreach collection="pageable.sort" item="order" separator=",">
                ${order.property} ${order.direction}
            </foreach>
        </if>
        <if test="!pageable.sort.isSorted()">
            ORDER BY created_at DESC
        </if>

        OFFSET #{pageable.offset} ROWS
        FETCH NEXT #{pageable.pageSize} ROWS ONLY
    </select>

    <select id="sumTotalClicks" resultType="long">
        SELECT
        COUNT(*)
        FROM
        short_url_clicks
        WHERE
        short_url_id = #{shortUrlId}
        <include refid="commonFilterClause"/>
    </select>

    <insert id="bulkInsert" parameterType="java.util.List">
        INSERT INTO short_url_clicks (short_url_id, country_code, device_type, referrer, domain, created_at)
        VALUES
        <foreach collection="list" item="item" separator=",">
            (
            #{item.shortUrlId},
            #{item.countryCode},
            #{item.deviceType},
            #{item.referrer},
            #{item.domain},
            #{item.timestamp}
            )
        </foreach>
    </insert>

</mapper>

