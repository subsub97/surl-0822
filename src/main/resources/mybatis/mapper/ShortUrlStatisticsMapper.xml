<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.megastudy.surlkdh.domain.statistics.infrastructure.mybatis.mapper.ShortUrlStatisticsMapper">

    <!-- StatisticResponse DTO로 결과를 매핑합니다. -->
    <resultMap id="statisticsResultMap"
               type="com.megastudy.surlkdh.domain.statistics.controller.dto.response.StatisticsDataPoint">
        <result property="key" column="key_column"/>
        <result property="clicks" column="clicks_column"/>
    </resultMap>

    <!-- 공통 WHERE 조건문 -->
    <sql id="commonWhereClause">
        <where>
            <if test="request.startDate != null">
                AND created_at >= #{request.startDate}
            </if>
            <if test="request.endDate != null">
                AND created_at &lt;= #{request.endDate}
            </if>
            <!-- 다른 필터 조건들도 여기에 추가할 수 있습니다. -->
        </where>
    </sql>

    <!-- 동적 그룹 통계 조회 쿼리 -->
    <select id="findGroupByStatistics" resultMap="statisticsResultMap">
        SELECT
        <choose>
            <when test="request.groupBy.name() == 'SHORT_URL'">short_url_id</when>
            <when test="request.groupBy.name() == 'DEVICE'">device_type</when>
            <when test="request.groupBy.name() == 'COUNTRY'">country_code</when>
            <when test="request.groupBy.name() == 'REFERRER'">referrer</when>
            <when test="request.groupBy.name() == 'DAILY'">CAST(created_at AS DATE)</when>
            <when test="request.groupBy.name() == 'MONTHLY'">FORMAT(created_at, 'yyyy-MM')</when>
            <when test="request.groupBy.name() == 'HOURLY'">FORMAT(created_at, 'yyyy-MM-dd HH:00')</when>
            <otherwise>short_url_id</otherwise> <!-- 기본값 또는 예외 처리 -->
        </choose>
        AS key_column,
        COUNT(*) AS clicks_column
        FROM
        short_url_clicks
        <include refid="commonWhereClause"/>
        GROUP BY
        <choose>
            <when test="request.groupBy.name() == 'SHORT_URL'">short_url_id</when>
            <when test="request.groupBy.name() == 'DEVICE'">device_type</when>
            <when test="request.groupBy.name() == 'COUNTRY'">country_code</when>
            <when test="request.groupBy.name() == 'REFERRER'">referrer</when>
            <when test="request.groupBy.name() == 'DAILY'">CAST(created_at AS DATE)</when>
            <when test="request.groupBy.name() == 'MONTHLY'">FORMAT(created_at, 'yyyy-MM')</when>
            <when test="request.groupBy.name() == 'HOURLY'">FORMAT(created_at, 'yyyy-MM-dd HH:00')</when>
            <otherwise>short_url_id</otherwise>
        </choose>
        <!-- 동적 정렬 -->
        <if test="pageable.sort.isSorted()">
            ORDER BY
            <foreach collection="pageable.sort" item="order" separator=",">
                <choose>
                    <when test="order.property == 'clicks'">clicks_column ${order.direction}</when>
                    <when test="order.property == 'key'">key_column ${order.direction}</when>
                    <otherwise>clicks_column DESC</otherwise>
                </choose>
            </foreach>
        </if>
        <if test="!pageable.sort.isSorted()">
            ORDER BY clicks_column DESC
        </if>
        <!-- 페이지네이션 -->
        OFFSET #{pageable.offset} ROWS
        FETCH NEXT #{pageable.pageSize} ROWS ONLY
    </select>

    <!-- 동적 그룹 통계의 전체 개수 조회 쿼리 (페이지네이션용) -->
    <select id="countGroupByStatistics" resultType="long">
        SELECT
        COUNT(DISTINCT
        <choose>
            <when test="request.groupBy.name() == 'SHORT_URL'">short_url_id</when>
            <when test="request.groupBy.name() == 'DEVICE'">device_type</when>
            <when test="request.groupBy.name() == 'COUNTRY'">country_code</when>
            <when test="request.groupBy.name() == 'REFERRER'">referrer</when>
            <when test="request.groupBy.name() == 'DAILY'">CAST(created_at AS DATE)</when>
            <when test="request.groupBy.name() == 'MONTHLY'">FORMAT(created_at, 'yyyy-MM')</when>
            <when test="request.groupBy.name() == 'HOURLY'">FORMAT(created_at, 'yyyy-MM-dd HH:00')</when>
            <otherwise>short_url_id</otherwise>
        </choose>
        )
        FROM
        short_url_clicks
        <include refid="commonWhereClause"/>
    </select>

    <insert id="bulkInsert" parameterType="java.util.List">
        INSERT INTO short_url_clicks (short_url_id, country_code, device_type, referrer, domain, created_at)
        VALUES
        <foreach collection="list" item="item" separator=",">
            (
            #{item.shortUrlId},
            #{item.countryCode},
            #{item.deviceType},
            #{item.referrer},
            #{item.domain},
            #{item.timestamp}
            )
        </foreach>
    </insert>

</mapper>